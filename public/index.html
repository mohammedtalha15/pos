<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        .ticket-pop-in {
            animation: popIn 0.3s ease-out forwards;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-100 font-sans antialiased">

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-gradient-to-r from-gray-800 to-gray-900 shadow-xl sticky top-0 z-10 border-b border-gray-700">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="ph ph-fork-knife text-red-500 text-3xl"></i>
                    <h1 class="text-xl font-bold text-white">POS</h1>
                </div>
                <div class="flex space-x-2 bg-gray-700 p-1 rounded-lg">
                    <button id="btn-waiter-view" class="px-4 py-2 text-sm font-medium rounded-md transition-all bg-red-500 text-white" onclick="switchView('waiter')">
                        <i class="ph ph-notebook mr-1"></i> Waiter View
                    </button>
                    <button id="btn-kitchen-view" class="px-4 py-2 text-sm font-medium rounded-md transition-all hover:bg-gray-600" onclick="switchView('kitchen')">
                        <i class="ph ph-flame mr-1"></i> Kitchen View
                    </button>
                </div>
                <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-700 transition-all">
                    <i id="theme-icon" class="ph ph-moon text-xl"></i>
                </button>
            </nav>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 bg-gradient-to-b from-transparent to-gray-900/50">
            <div id="waiter-view">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="mb-6">
                            <h2 class="text-2xl font-semibold mb-3 flex items-center text-white">
                                <i class="ph ph-stack text-red-500 mr-2"></i> Select Table
                            </h2>
                            <div class="p-4 bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg shadow-lg border border-gray-700">
                                <div class="flex items-center gap-4 mb-3">
                                    <label for="table-number" class="font-medium text-gray-200 whitespace-nowrap">Table Number:</label>
                                    <input type="number" id="table-number" min="1" class="w-32 p-2.5 border border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-white font-semibold text-center" value="1">
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-400 font-medium">Quick Select:</span>
                                    <div id="table-buttons-container" class="flex flex-wrap gap-2">
                                        <!-- Table buttons will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-2xl font-semibold mb-3 flex items-center text-white">
                                <i class="ph ph-list-bullets text-red-500 mr-2"></i> Menu
                            </h2>
                            <div class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                                <button class="px-4 py-2 rounded-lg bg-red-500 text-white transition-all font-medium" onclick="filterMenu('all')">All</button>
                                <button class="px-4 py-2 rounded-lg bg-gray-800 shadow-sm transition-all font-medium border border-gray-700 hover:bg-gray-700" onclick="filterMenu('appetizers')">Appetizers</button>
                                <button class="px-4 py-2 rounded-lg bg-gray-800 shadow-sm transition-all font-medium border border-gray-700 hover:bg-gray-700" onclick="filterMenu('mains')">Mains</button>
                                <button class="px-4 py-2 rounded-lg bg-gray-800 shadow-sm transition-all font-medium border border-gray-700 hover:bg-gray-700" onclick="filterMenu('drinks')">Drinks</button>
                                <button class="px-4 py-2 rounded-lg bg-gray-800 shadow-sm transition-all font-medium border border-gray-700 hover:bg-gray-700" onclick="filterMenu('desserts')">Desserts</button>
                            </div>
                            <div id="menu-items-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                        </div>
                    </div>

                    <div class="lg:col-span-1">
                        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-xl sticky top-24 border border-gray-700">
                            <div class="p-4 border-b border-gray-700">
                                <h2 class="text-2xl font-semibold flex items-center justify-between text-white">
                                    <span>Current Order</span>
                                    <span id="current-order-table" class="text-lg font-medium text-red-500">Table 1</span>
                                </h2>
                            </div>
                            
                            <div id="current-order-list" class="p-4 h-64 overflow-y-auto">
                                <div id="order-empty-state" class="flex flex-col items-center justify-center h-full text-gray-400">
                                    <i class="ph ph-shopping-cart text-5xl"></i>
                                    <p class="mt-2 font-medium">No items added</p>
                                    <p class="text-sm">Click menu items to add</p>
                                </div>
                            </div>

                            <div class="p-4 border-t border-gray-700">
                                <label for="special-notes" class="block text-sm font-medium mb-1 text-gray-200">Special Notes:</label>
                                <textarea id="special-notes" rows="2" class="w-full p-2 border border-gray-600 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-white placeholder-gray-400" placeholder="e.g., extra spicy, no nuts..."></textarea>
                            </div>

                            <div class="p-4 border-t border-gray-700 bg-gray-800/50 rounded-b-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <span class="text-lg font-medium text-gray-200">Total Items:</span>
                                    <span id="total-items-count" class="text-lg font-bold text-white">0</span>
                                </div>
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-lg font-medium text-gray-200">Total Price:</span>
                                    <span id="total-price" class="text-2xl font-bold text-red-500">$0.00</span>
                                </div>
                                <button id="submit-order-btn" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white text-lg font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg" onclick="submitOrder()">
                                    <i class="ph ph-paper-plane-tilt"></i>
                                    <span>Submit Order</span>
                                </button>
                                <button class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2 px-4 rounded-lg transition-all mt-2" onclick="clearOrder()">
                                    Clear Order
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="kitchen-view" class="hidden">
                <h2 class="text-3xl font-bold mb-6 flex items-center text-white">
                    <i class="ph ph-flame text-red-500 mr-3"></i> Kitchen Display
                </h2>
                
                <div id="kitchen-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div id="kitchen-empty-state" class="col-span-full flex flex-col items-center justify-center h-96 text-gray-400">
                        <i class="ph ph-coffee text-7xl"></i>
                        <p class="mt-4 text-2xl font-medium">All clear!</p>
                        <p class="text-lg">No active orders.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="toast" class="fixed bottom-5 right-5 bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-3 rounded-lg shadow-xl translate-x-full transition-transform duration-300 ease-in-out z-50 flex items-center space-x-2">
            <i class="ph ph-check-circle text-xl"></i>
            <span id="toast-message">Order Submitted!</span>
        </div>
    </div>

    <script>
        const MENU = [
            { id: 1, name: 'Classic Burger', price: 14.00, category: 'mains', image: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=300&fit=crop' },
            { id: 2, name: 'Caesar Salad', price: 12.00, category: 'appetizers', image: 'https://images.unsplash.com/photo-1546793665-c74683f339c1?w=400&h=300&fit=crop' },
            { id: 3, name: 'French Fries', price: 4.00, category: 'appetizers', image: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=400&h=300&fit=crop' },
            { id: 4, name: 'Steak Frites', price: 28.00, category: 'mains', image: 'https://images.unsplash.com/photo-1546833999-b9f581a1996d?w=400&h=300&fit=crop' },
            { id: 5, name: 'Grilled Salmon', price: 22.00, category: 'mains', image: 'https://images.unsplash.com/photo-1467003909585-2f8a72700288?w=400&h=300&fit=crop' },
            { id: 6, name: 'Coca-Cola', price: 3.00, category: 'drinks', image: 'https://images.unsplash.com/photo-1554866585-cd1ca793c0ef?w=400&h=300&fit=crop' },
            { id: 7, name: 'Spring Water', price: 2.00, category: 'drinks', image: 'https://images.unsplash.com/photo-1523362628745-0c100150b504?w=400&h=300&fit=crop' },
            { id: 8, name: 'Cheesecake', price: 8.00, category: 'desserts', image: 'https://images.unsplash.com/photo-1524351199678-941a58a3df50?w=400&h=300&fit=crop' },
            { id: 9, name: 'Calamari', price: 13.00, category: 'appetizers', image: 'https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400&h=300&fit=crop' },
            { id: 10, name: 'Pasta Carbonara', price: 18.00, category: 'mains', image: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=400&h=300&fit=crop' },
            { id: 11, name: 'Iced Tea', price: 3.00, category: 'drinks', image: 'https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=400&h=300&fit=crop' },
            { id: 12, name: 'Chocolate Lava Cake', price: 9.00, category: 'desserts', image: 'https://images.unsplash.com/photo-1606313564200-e75d5e30476c?w=400&h=300&fit=crop' },
        ];

        let currentOrder = [];
        let allOrders = [];
        let currentFilter = 'all';

        const waiterV = document.getElementById('waiter-view');
        const kitchenV = document.getElementById('kitchen-view');
        const btnWaiterV = document.getElementById('btn-waiter-view');
        const btnKitchenV = document.getElementById('btn-kitchen-view');
        const menuGrid = document.getElementById('menu-items-grid');
        const currentOrderList = document.getElementById('current-order-list');
        const orderEmptyState = document.getElementById('order-empty-state');
        const totalItemsCount = document.getElementById('total-items-count');
        const totalPriceEl = document.getElementById('total-price');
        const tableNumberInput = document.getElementById('table-number');
        const currentOrderTable = document.getElementById('current-order-table');
        const specialNotesInput = document.getElementById('special-notes');
        const submitBtn = document.getElementById('submit-order-btn');
        const kitchenGrid = document.getElementById('kitchen-orders-grid');
        const kitchenEmptyState = document.getElementById('kitchen-empty-state');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');

        function switchView(view) {
            if (view === 'waiter') {
                waiterV.style.display = 'block';
                kitchenV.style.display = 'none';
                btnWaiterV.classList.add('bg-red-500', 'text-white');
                btnWaiterV.classList.remove('hover:bg-gray-600');
                btnKitchenV.classList.remove('bg-red-500', 'text-white');
                btnKitchenV.classList.add('hover:bg-gray-600');
            } else {
                waiterV.style.display = 'none';
                kitchenV.style.display = 'block';
                btnWaiterV.classList.remove('bg-red-500', 'text-white');
                btnWaiterV.classList.add('hover:bg-gray-600');
                btnKitchenV.classList.add('bg-red-500', 'text-white');
                btnKitchenV.classList.remove('hover:bg-gray-600');
                renderKitchenView();
            }
        }

        function toggleDarkMode() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            html.classList.toggle('dark');
            if (html.classList.contains('dark')) {
                themeIcon.classList.remove('ph-sun');
                themeIcon.classList.add('ph-moon');
            } else {
                themeIcon.classList.remove('ph-moon');
                themeIcon.classList.add('ph-sun');
            }
        }
        
        function showToast(message) {
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');
            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        function renderMenu(filter = 'all') {
            menuGrid.innerHTML = '';
            const filteredMenu = filter === 'all' 
                ? MENU 
                : MENU.filter(item => item.category === filter);

            filteredMenu.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 border border-gray-700';
                btn.onclick = () => addItemToOrder(item);
                btn.innerHTML = `
                    <div class="w-full h-24 bg-gradient-to-br from-gray-700 to-gray-800 overflow-hidden">
                        <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-800" style="display:none;">
                            <i class="ph ph-fork-knife text-4xl text-gray-400"></i>
                        </div>
                    </div>
                    <div class="p-2 text-center">
                        <p class="font-semibold text-sm truncate text-white">${item.name}</p>
                        <p class="text-xs text-red-500 font-bold">$${item.price.toFixed(2)}</p>
                    </div>
                `;
                menuGrid.appendChild(btn);
            });
        }

        window.filterMenu = (category) => {
            currentFilter = category;
            document.querySelectorAll('#waiter-view button[onclick^="filterMenu"]').forEach(btn => {
                btn.classList.remove('bg-red-500', 'text-white');
                btn.classList.add('bg-gray-800', 'border', 'border-gray-700', 'hover:bg-gray-700');
            });
            const activeButton = document.querySelector(`#waiter-view button[onclick="filterMenu('${category}')"]`);
            activeButton.classList.add('bg-red-500', 'text-white');
            activeButton.classList.remove('bg-gray-800', 'border', 'border-gray-700', 'hover:bg-gray-700');
            renderMenu(category);
        }
        
        window.setTable = (num) => {
            tableNumberInput.value = num;
            updateOrderSummary();
        }

        window.addItemToOrder = (item) => {
            currentOrder.push(item);
            updateOrderSummary();
        }

        window.removeItemFromOrder = (index) => {
            currentOrder.splice(index, 1);
            updateOrderSummary();
        }

        function updateOrderSummary() {
            if (currentOrder.length === 0) {
                orderEmptyState.style.display = 'flex';
                currentOrderList.innerHTML = '';
                submitBtn.disabled = true;
            } else {
                orderEmptyState.style.display = 'none';
                currentOrderList.innerHTML = '';
                let totalPrice = 0;
                
                const grouped = currentOrder.reduce((acc, item) => {
                    const key = item.id;
                    if (!acc[key]) acc[key] = { ...item, count: 0 };
                    acc[key].count++;
                    return acc;
                }, {});

                Object.values(grouped).forEach((item, idx) => {
                    totalPrice += item.price * item.count;
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-2 border-b border-gray-700';
                    div.innerHTML = `
                        <div>
                            <p class="font-medium text-white">${item.count}x ${item.name}</p>
                            <p class="text-sm text-gray-400">$${(item.price * item.count).toFixed(2)}</p>
                        </div>
                        <button class="text-red-500 hover:text-red-700" onclick="removeItemFromOrder(${currentOrder.findIndex(x => x.id === item.id)})">
                            <i class="ph ph-x-circle text-xl"></i>
                        </button>
                    `;
                    currentOrderList.appendChild(div);
                });
                
                totalPriceEl.textContent = `$${totalPrice.toFixed(2)}`;
                submitBtn.disabled = false;
            }
            
            totalItemsCount.textContent = currentOrder.length;
            currentOrderTable.textContent = `Table ${tableNumberInput.value || '?'}`;
        }
        
        window.clearOrder = () => {
            currentOrder = [];
            specialNotesInput.value = '';
            tableNumberInput.value = '1';
            updateOrderSummary();
        }

        window.submitOrder = async () => {
            if (currentOrder.length === 0) return;

            const tableNumber = Number(tableNumberInput.value);
            const items = currentOrder.map(item => item.name);
            const notes = specialNotesInput.value.trim();
            const totalPrice = currentOrder.reduce((sum, item) => sum + item.price, 0);

            try {
                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tableNumber, items, notes, totalPrice })
                });

                if (!res.ok) throw new Error('Failed to submit order');
                
                const order = await res.json();
                const orderNo = order.id.substring(0, 8).toUpperCase();
                showToast(`✅ Order No ${orderNo} for Table ${order.tableNumber} submitted!`);
                clearOrder();
                loadOrders();
            } catch (err) {
                showToast('Error submitting order. Please try again.');
                console.error(err);
            }
        }

        function renderKitchenView() {
            kitchenGrid.innerHTML = '';
            const activeOrders = allOrders.filter(order => order.status !== 'ready' || true);

            if (activeOrders.length === 0) {
                kitchenEmptyState.style.display = 'flex';
            } else {
                kitchenEmptyState.style.display = 'none';
                
                activeOrders.sort((a, b) => {
                    const rank = { 'new': 0, 'preparing': 1, 'ready': 2 };
                    if (rank[a.status] !== rank[b.status]) return rank[a.status] - rank[b.status];
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                activeOrders.forEach(order => {
                    const ticket = createTicketHTML(order);
                    kitchenGrid.innerHTML += ticket;
                });
            }
        }

        function createTicketHTML(order) {
            const itemsSummary = order.items.reduce((acc, item) => {
                const key = typeof item === 'string' ? item : item.name || item;
                if (!acc[key]) acc[key] = { name: key, count: 0 };
                acc[key].count++;
                return acc;
            }, {});

            const itemsHTML = Object.values(itemsSummary).map(item => `
                <li class="flex justify-between items-center py-1">
                    <span class="font-semibold text-lg text-white">${item.count}x ${item.name}</span>
                </li>
            `).join('');

            const notesHTML = order.notes ? `
                <div class="mt-4 p-2 bg-red-900/30 border border-red-700 rounded-md">
                    <p class="text-red-200 text-sm font-medium"><i class="ph ph-warning-circle mr-1"></i> ${order.notes}</p>
                </div>
            ` : '';

            let statusColor, actionButton;
            const status = order.status || 'new';
            switch (status) {
                case 'new':
                    statusColor = 'border-yellow-400';
                    actionButton = `<button class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg" onclick="updateOrderStatus('${order.id}', 'preparing')">
                                        Start Preparing
                                    </button>`;
                    break;
                case 'preparing':
                    statusColor = 'border-blue-400';
                    actionButton = `
                        <button class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg mb-2 flex items-center justify-center space-x-2" onclick="updateOrderStatus('${order.id}', 'ready')">
                            <i class="ph ph-check-circle text-xl"></i>
                            <span>Mark Order Ready</span>
                        </button>
                        <button class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all" onclick="updateOrderStatus('${order.id}', 'new')">
                            Back to New
                        </button>
                    `;
                    break;
                case 'ready':
                    statusColor = 'border-green-400';
                    actionButton = `
                        <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-3 mb-2">
                            <div class="flex items-center justify-center space-x-2 text-green-400 font-bold">
                                <i class="ph ph-check-circle text-2xl"></i>
                                <span>ORDER READY</span>
                            </div>
                        </div>
                        <button class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-medium py-2 px-4 rounded-lg transition-all" onclick="updateOrderStatus('${order.id}', 'preparing')">
                            Mark as Preparing
                        </button>
                    `;
                    break;
                default:
                    statusColor = 'border-gray-400';
                    actionButton = '';
            }
            
            const createdAt = new Date(order.createdAt);
            const timeSince = Math.round((new Date() - createdAt) / 60000);
            const timeDisplay = timeSince < 1 ? 'Just now' : `${timeSince} min ago`;

            const orderNumber = order.id.substring(0, 8).toUpperCase();
            const statusBadge = status === 'new' ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30' : 
                                status === 'preparing' ? 'bg-blue-500/20 text-blue-400 border-blue-500/30' : 
                                'bg-green-500/20 text-green-400 border-green-500/30';
            const statusText = status === 'new' ? 'NEW' : status === 'preparing' ? 'PREPARING' : 'READY';

            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg shadow-xl flex flex-col h-full border-t-4 ${statusColor} ticket-pop-in border border-gray-700">
                    <div class="p-4 border-b border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h3 class="text-2xl font-bold text-white">Table ${order.tableNumber}</h3>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold border ${statusBadge}">
                                ${statusText}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Order No:</span>
                            <span class="text-lg font-bold text-red-400">#${orderNumber}</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            ${timeDisplay}
                        </div>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto min-h-[150px]">
                        <ul class="space-y-1">
                            ${itemsHTML}
                        </ul>
                        ${notesHTML}
                    </div>
                    <div class="p-4 bg-gray-800/50 rounded-b-lg mt-auto">
                        ${actionButton}
                    </div>
                </div>
            `;
        }
        
        window.updateOrderStatus = async (orderId, newStatus) => {
            try {
                // Find order before update for toast message
                const orderBefore = allOrders.find(o => o.id === orderId);
                const orderNo = orderBefore ? orderBefore.id.substring(0, 8).toUpperCase() : '';
                const tableNum = orderBefore ? orderBefore.tableNumber : '';

                const res = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!res.ok) throw new Error('Failed');
                
                await loadOrders();
                
                if (orderBefore) {
                    if (newStatus === 'preparing') {
                        showToast(`Order No ${orderNo} - Table ${tableNum} is now being prepared`);
                    } else if (newStatus === 'ready') {
                        showToast(`✅ Order No ${orderNo} - Table ${tableNum} is READY!`);
                    } else if (newStatus === 'new') {
                        showToast(`Order No ${orderNo} - Table ${tableNum} moved back to New`);
                    }
                }
            } catch (err) {
                console.error(err);
                showToast('Error updating order status');
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders');
                const data = await res.json();
                allOrders = data.orders || [];
                renderKitchenView();
            } catch (err) {
                console.error(err);
            }
        }

        function connectStream() {
            const es = new EventSource('/api/stream');
            es.addEventListener('order_created', () => loadOrders());
            es.addEventListener('order_updated', () => loadOrders());
            es.onerror = () => {
                es.close();
                setTimeout(connectStream, 2000);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            toggleDarkMode();
            toggleDarkMode();
            switchView('waiter');
            renderMenu('all');
            updateOrderSummary();
            loadOrders();
            connectStream();
            tableNumberInput.addEventListener('input', updateOrderSummary);

            // Create table number buttons
            const tableButtonsContainer = document.getElementById('table-buttons-container');
            if (tableButtonsContainer) {
                const tableNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20];
                tableNumbers.forEach(num => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'px-4 py-2 rounded-lg bg-gray-700 hover:bg-red-500 hover:scale-105 transition-all font-medium text-white text-sm min-w-[48px]';
                    btn.textContent = num;
                    btn.onclick = () => setTable(num);
                    tableButtonsContainer.appendChild(btn);
                });
            }
        });
    </script>
</body>
</html>